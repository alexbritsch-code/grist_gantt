<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <script src="https://unpkg.com/frappe-gantt/dist/frappe-gantt.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/frappe-gantt/dist/frappe-gantt.css">
  <style>
    body { font-family: sans-serif; }
    /* Curseur pointer pour les barres cliquables */
    .bar { cursor: pointer; }
  </style>
</head>
<body>
  <svg id="gantt"></svg>

  <script>
    grist.ready();

    grist.onRecords(function(records) {
      let tasks = [];

      records.forEach(r => {
        if (!r["Date Entrée"] || !r["Date Sortie"] || !r["Espaces 61"]) return;

        r["Espaces 61"].forEach(espace => {
          tasks.push({
            id: `${r.id}-${espace.id}`,
            name: `${espace.Nom} – ${r.Projet}`,
            start: r["Date Entrée"],
            end: r["Date Sortie"],
            recordUrl: r._url  // <-- l’URL de la ligne projet
          });
        });
      });

      const gantt = new Gantt("#gantt", tasks, {
        view_mode: "Month",
        language: "fr",
        bar_height: 24,
        custom_popup_html: null  // désactive le popup par défaut
      });

      // Ajouter le clic pour ouvrir la fiche
      gantt.tasks.forEach(task => {
        task.$bar.addEventListener("click", () => {
          if (task.task.recordUrl) {
            window.open(task.task.recordUrl, "_blank");
          }
        });
      });
    });
  </script>
</body>
</html>
